# Enable Rewrite Engine
RewriteEngine On
RewriteBase /

# Prevent access to sensitive files
<FilesMatch "\.(sql|log|md)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Route /admin to admin login (must be before file/directory check)
RewriteCond %{REQUEST_URI} ^/admin/?$
RewriteRule ^admin/?$ admin_login.php [L]

# Route /login to user login
RewriteCond %{REQUEST_URI} ^/login/?$
RewriteRule ^login/?$ auth/otp_login.php [L]

# Route /contact to contact page
RewriteCond %{REQUEST_URI} ^/contact/?$
RewriteRule ^contact/?$ contact.php [L]

# Route /store to store page
RewriteCond %{REQUEST_URI} ^/store/?$
RewriteRule ^store/?$ store.php [L]

# Route /help/* to help pages (clean URLs)
RewriteRule ^help/(download-guide|refund-guide|payment-issues|account-security)/?$ help/$1.php [L,NC]

# Route /help to help index
RewriteCond %{REQUEST_URI} ^/help/?$
RewriteRule ^help/?$ help/download-guide.php [L]

# Route /dashboard to dashboard router (empty route)
RewriteCond %{REQUEST_URI} ^/dashboard/?$
RewriteRule ^dashboard/?$ dashboard/router.php?route= [L,QSA]

# Redirect /dashboard/auth/logout.php to /auth/logout.php (backward compatibility)
RewriteCond %{REQUEST_URI} ^/dashboard/auth/logout\.php
RewriteRule ^dashboard/auth/logout\.php$ /auth/logout.php [R=301,L]

# Route /dashboard/* requests to dashboard router
# This handles URLs like /dashboard/my-purchases
RewriteCond %{REQUEST_URI} ^/dashboard/(.+)$
RewriteCond %{REQUEST_URI} !^/dashboard/auth/
RewriteCond %{REQUEST_URI} !^/dashboard/(get_dashboard_stats|get_notifications_count|check_session|process_refund|get_ticket|router)\.php$ [NC]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^dashboard/(.+)$ dashboard/router.php?route=$1 [L,QSA]

# Handle direct PHP file access (redirect to clean URL)
RewriteCond %{REQUEST_URI} ^/dashboard/(my_purchases|downloads|receipts|refunds|support|settings|notifications|index)\.php$ [NC]
RewriteRule ^dashboard/(.+)\.php$ /dashboard/$1 [L,QSA,R=301]

# Allow direct access to existing files and directories (after routing rules)
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Standard directory index
DirectoryIndex index.php index.html
